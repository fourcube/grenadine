<html>
<head>
<script type="text/javascript" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/q.js/1.1.2/q.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script type="text/javascript" src="static/grenadine.js"></script>
<script type="text/javascript" charset="utf-8">
jQuery.each( [ "put", "delete" ], function( i, method ) {
  jQuery[ method ] = function( url, data, callback, type ) {
    if ( jQuery.isFunction( data ) ) {
      type = type || callback;
      callback = data;
      data = undefined;
    }

    return jQuery.ajax({
      url: url,
      type: method,
      dataType: type,
      data: data,
      success: callback
    });
  };
});


var socket = io.connect('http://' + document.domain + ':' + location.port);
socket.on('connect', function() {
  console.log("Connected.");
  socket.emit('connect');
});

var setOnClick = function(target, callback) {
  target.off('click')
  target.on('click', callback);
};

var activate = function(e) {
  var pin = e.currentTarget.id;
  $.post('/pin/' + pin)
  .done(function () {
    setOnClick($(e.currentTarget), deactivate);
  });
};

var deactivate = function(e) {
  var pin = e.currentTarget.id;
  $.delete('/pin/' + pin)
  .done(function () {
    setOnClick($(e.currentTarget), activate);
  });
};

var clearAll = function(e) {
  $.get('/clear');
};

socket.on('pins', function(data) {
  $('#pins').empty();
  data.forEach(function(pin) {
    var el = $('<div class="pin" id="'+pin+'">Pin #' + pin + '</div>');
    el.on('click', activate);
    $('#pins').append(el);
  });

  socket.emit('get status');
});


socket.on('update', function(data) {
  $.each(data, function(k,v) {
    $('#' + k).removeClass('active');
    if(v) {
      setOnClick($('#' + k), deactivate);
      $('#' + k).addClass('active');
    } else {
      setOnClick($('#' + k), activate);
    }
  });
});


var execute = function () {
  var code = $('#command-editor').val();
  eval(code);
}

$('document').ready(function () {
  $('#clear').on('click', clearAll);
  $('#execute').on('click', execute);
  $.get('static/demo.js').done(function (data) {
    $('#command-editor').val(data);
  });
});

</script>
<style>
.pin {
  font-size: 30px;
  width: 200px;
  color: #bbbbbb;
  background-color: #666666;
  float: left;
  margin-right: 1%;
  padding-left: 1%;
  margin-bottom: 1%;
}
.pin.active {
  background-color: green;
  color: #ebebeb;
}
.cmd {
  width: 300px;
  font-size: 60px;
  color: #ebebeb;
  background-color: #000;
  float: left;
  margin-right: 1%;
  padding-left: 1%;
  margin-bottom: 1%;
  clear: both;
}
.commands {
  margin-left: 1%;
  margin-bottom: 1%;
  clear: both;
  width: 98%;
  height: 300px;
}
</style>
</head>
<body>
  <div id="pins">
  </div>
  <textarea id="command-editor" class="commands" value=""></textarea>
  <div id="execute" class="cmd">Execute</div>
  <div id="clear" class="cmd">Clear all</div>

</body>
</html>
